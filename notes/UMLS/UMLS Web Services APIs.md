# UMLS Web Services APIs

## Authentication

Whether we are using Code or Restful Client to access UMLS data, we have to authenticate before we can access. 

*Prerequisite* 

- Get **API key** from UMLS: login to [UMLS]([https://utslogin.nlm.nih.gov/cas/login?service=https%3A%2F%2Futs.nlm.nih.gov%3A443%2F%2Fj_spring_cas_security_check](https://utslogin.nlm.nih.gov/cas/login?service=https%3A%2F%2Futs.nlm.nih.gov%3A443%2F%2Fj_spring_cas_security_check)  and navigate to "My Profile" page. Copy/Paste and save the API key

- If you are using Python to access UMLS web API, you can have a look at the [example code]([https://github.com/HHS/uts-rest-api](https://github.com/HHS/uts-rest-api)  

## Steps:

Whether we are using RESTful Client or code to access UMLS web API, we have to go through the following steps.

1. Getting Ticket-Granting Ticket(TGT): this ticket will allow us to get Service Ticket in the next 8 hours without getting a new TGT again

2. Getting Service Ticket(ST): A service ticket can be generated by a TGT. A Service Ticket expires after one use or five minutes from the time of generation, whichever comes first.

3. Starting query with Service Ticket.

Now we describe these steps in details.

## Getting Ticket-Granting Ticket(TGT)

**Getting TGT through RESTful Client** 

Emit the following request in your RESTful Client

| Type of Request | URI                                         | Content type     | Key Names | Key Values        |
| --------------- | ------------------------------------------- | ---------------- | --------- | ----------------- |
| POST            | https://utslogin.nlm.nih.gov/cas/v1/api-key | url-encoded body | apikey    | Your UMLS API key |

curl request example:

```html
curl -X POST https://utslogin.nlm.nih.gov/cas/v1/api-key -H 'content-type: application/x-www-form-urlencoded' -d apikey={your_api_key_here}
```

Header of the returned result has the following form

```
https://utslogin.nlm.nih.gov/cas/v1/api-key/{your TGT here}`
```

Example: `

```
https://utslogin.nlm.nih.gov/cas/v1/tickets/TGT-36471-aYqNLN2rFIJPXKzxwdTNC5ZT7z3B3cTAKfSc5ndHQcUxeaDOLN-cas`
```

**Getting TGT through Python code**

There is [example code]([https://github.com/HHS/uts-rest-api/blob/master/samples/python/Authentication.py](https://github.com/HHS/uts-rest-api/blob/master/samples/python/Authentication.py) for authenticating using Python script. `gettgt` function in `Authentication` class can be used to get a TGT.

```python
from Authentication import Authentication

# specify your API key
API_KEY = {put your API key}
# initialize authentication using API key
authentication = Authentication(apikey=API_KEY)
# get TGT
tgt = authentication.gettgt()
```

## Getting Service Ticket(ST)

**Getting Service Ticket(ST) through RESTful Client**

| Type of Request | URI                                                    | Content type     | Key Name | Key Value                 |
| --------------- | ------------------------------------------------------ | ---------------- | -------- | ------------------------- |
| POST            | https://utslogin.nlm.nih.gov/cas/v1/tickets/{your TGT} | url-encoded body | service  | http://umlsks.nlm.nih.gov |

ST will be returned as result.

Example:

```
ST-134-HUbXGfI765aSj0UqtdvU-cas
```

**Getting TGT through Python code**

After getting the TGT, you can use `getst` function in `Authentication` class to get a ST.

From the Python code on getting TGT ticket, get the service ticket

```python
st = authentication.getst(tgt)
```

## Starting query with Service Ticket

**Starting query through RESTful client**

Now you can query UMSL with the ST. For example

```
https://uts-ws.nlm.nih.gov/rest/content/current/CUI/C0018787?ticket=ST-1257438-2asYUtMzewbhc3G2sF9Y-cas
```

**Starting query through Python code**

Continuing from the TGT and Service Ticket section, query using the service ticket. The following example code search for `ACE2` in UMLS.

```python
import requests
import json

# query string is "ACE2"
# put service ticket for the "ticket" key
query = {'string':"ACE2",'ticket':st}
# construct the REST API endpoint
uri = "https://uts-ws.nlm.nih.gov"
version = "current"
content_endpoint = "/rest/search/"+version

# request through the endpoint
r = requests.get(uri+content_endpoint,params=query)

# analyze returned result

r.encoding = 'utf-8'
items  = json.loads(r.text)
jsonData = items["result"]
```
